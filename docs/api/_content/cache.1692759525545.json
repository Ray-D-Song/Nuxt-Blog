{"generatedAt":1692759547571,"generateTime":2127,"contents":[{"_path":"/1692667782462","_dir":"","_draft":false,"_partial":false,"_locale":"","_empty":false,"title":"协程(Coroutine)和纤程(Fiber)","description":"最近在看 C++ 引入 Fiber 的[N4024文档: 区分纤程和协程](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2014/n4024.pdf), 文章给纤程和协程十分明确的区分. 但过去我看过的很多资料会将其混为一谈或者模糊二者的边界, 所以写了这篇博客来总结一下.","cover":"https://pic-base-1307984077.cos.ap-nanjing.myqcloud.com/202308221107239.png","body":{"type":"root","children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"最近在看 C++ 引入 Fiber 的"},{"type":"element","tag":"a","props":{"href":"https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2014/n4024.pdf","rel":["nofollow"]},"children":[{"type":"text","value":"N4024文档: 区分纤程和协程"}]},{"type":"text","value":", 文章给纤程和协程十分明确的区分. 但过去我看过的很多资料会将其混为一谈或者模糊二者的边界, 所以写了这篇博客来总结一下."}]},{"type":"element","tag":"h1","props":{"id":"纤程"},"children":[{"type":"text","value":"纤程"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"线程是一种轻量级的线程, 本质是对线程时间进行切片处理, 调度也由用户进行. 最早是 Microsoft 为了解决 Unix 平台的引用程序移植到 Windows 上时出现的问题而发起的提案.\n因此, 纤程是一种偏底层的概念, 通常由操作系统或runtime自动管理, 并不需要程序员手动干预. 例如 Windows 上的纤程就是在其内核上实现."}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"值得注意的是, php8 引入的 Fiber 虽然叫做纤程, 其本质是协程."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"一个线程可以包含多个纤程, 纤程的好处是可以有效防止长时间的线程挂起. 例如在 IO 操作时, 实例化一个纤程进行 IO 操作, 在该纤程阻塞的过程中, 因为该线程仅占用了一部分的时间切片, 程序依旧可以继续执行."}]},{"type":"element","tag":"h1","props":{"id":"协程"},"children":[{"type":"text","value":"协程"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"协程的核心就是协作, 通过明确的挂起和恢复来控制执行的流程，使得不同任务之间可以更好地协同工作，共享信息，避免竞态条件，提高性能.\n协程在许多语言中都有实现, 例如 "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"Lua、Go、Ruby、Java(Virtual Threads)"}]},{"type":"text","value":", "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"Python 和 JavaScript(基于生成器)"}]},{"type":"text","value":".\n如果要用一句话来总结协程: "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"控制流的主动让出和恢复"}]},{"type":"text","value":"."}]},{"type":"element","tag":"h2","props":{"id":"有栈协程和无栈协程"},"children":[{"type":"text","value":"有栈协程和无栈协程"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"协程有很多种, 按照多个协程之间是否存在调用栈, 可以分为"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"有栈协程(如goroutine、lua协程)"}]},{"type":"text","value":"和"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"无栈协程(如JavaScript、Dart、Python)"}]},{"type":"text","value":"."}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"调用栈的作用是保存协程挂起时的状态.\n有栈协程在恢复时会将其上下文从栈内存中捞出恢复到系统栈中.\n无栈协程的挂起和恢复则依赖闭包和状态机实现."}]}]},{"type":"element","tag":"h2","props":{"id":"对称协程和非对称协程"},"children":[{"type":"text","value":"对称协程和非对称协程"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"非对称协程提供"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"两种控制操作"}]},{"type":"text","value":", "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"调用协程"}]},{"type":"text","value":"和"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"挂起协程"}]},{"type":"text","value":". 非对称协程可以看做是其调用者的从属, 跟特定调用者绑定, 在让出控制权时, 只能回到原调用者.\n对称协程提供"},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"单个控制操作"}]},{"type":"text","value":", 可以通过该操作在协程之间显示的传递控制权. 对称协程在启动后和原调用者就没什么关系了, 也因此, 对称协程需要一个调度器去选择转移控制权操作的目标协程."}]},{"type":"element","tag":"h3","props":{"id":"对称"},"children":[{"type":"text","value":"对称"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"对称协程的例子非常少, 以下是 C++ "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"Boost.Coroutine"}]},{"type":"text","value":" 的示例."}]},{"type":"element","tag":"code","props":{"className":["language-cpp"],"code":"#include <iostream>\n#include <coroutine>\n\nstruct CountingCoroutine {\n    struct promise_type {\n        int current_value = 0;\n\n        CountingCoroutine get_return_object() {\n            return CountingCoroutine(std::coroutine_handle<promise_type>::from_promise(*this));\n        }\n\n        std::suspend_always initial_suspend() { return {}; }\n        std::suspend_always final_suspend() noexcept { return {}; }\n        void return_void() {}\n        void unhandled_exception() {}\n        std::suspend_always yield_value(int value) {\n            current_value = value;\n            return {};\n        }\n    };\n\n    std::coroutine_handle<promise_type> coroutine;\n\n    CountingCoroutine(std::coroutine_handle<promise_type> handle) : coroutine(handle) {}\n\n    ~CountingCoroutine() {\n        if (coroutine)\n            coroutine.destroy();\n    }\n\n    int getValue() const {\n        return coroutine.promise().current_value;\n    }\n\n    void resume() {\n        coroutine.resume();\n    }\n};\n\nCountingCoroutine generateNumbers() {\n    for (int i = 0; i < 10; ++i) {\n        //移交控制权\n        co_yield i;\n    }\n}\n\nint main() {\n    CountingCoroutine counter = generateNumbers();\n\n    while (counter.coroutine) {\n        std::cout << \"Value: \" << counter.getValue() << std::endl;\n        //回到 co_yield 继续执行\n        counter.resume();\n    }\n\n    return 0;\n}\n","language":"cpp","meta":""},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"#include"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-695486"},"children":[{"type":"text","value":"<iostream>\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"#include"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-695486"},"children":[{"type":"text","value":"<coroutine>\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"struct"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-941699"},"children":[{"type":"text","value":"CountingCoroutine"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"struct"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-941699"},"children":[{"type":"text","value":"promise_type"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"int"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" current_value "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-055721"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":";\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-941699"},"children":[{"type":"text","value":"CountingCoroutine"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-941699"},"children":[{"type":"text","value":"get_return_object"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"() {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"            "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"return"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-941699"},"children":[{"type":"text","value":"CountingCoroutine"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-941699"},"children":[{"type":"text","value":"std"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"::"}]},{"type":"element","tag":"span","props":{"class":"ct-941699"},"children":[{"type":"text","value":"coroutine_handle"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"class":"ct-941699"},"children":[{"type":"text","value":"promise_type"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":">::"}]},{"type":"element","tag":"span","props":{"class":"ct-941699"},"children":[{"type":"text","value":"from_promise"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"*"}]},{"type":"element","tag":"span","props":{"class":"ct-055721"},"children":[{"type":"text","value":"this"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"));\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"        }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-941699"},"children":[{"type":"text","value":"std"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"::"}]},{"type":"element","tag":"span","props":{"class":"ct-941699"},"children":[{"type":"text","value":"suspend_always"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-941699"},"children":[{"type":"text","value":"initial_suspend"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"() { "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"return"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" {}; }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-941699"},"children":[{"type":"text","value":"std"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"::"}]},{"type":"element","tag":"span","props":{"class":"ct-941699"},"children":[{"type":"text","value":"suspend_always"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-941699"},"children":[{"type":"text","value":"final_suspend"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"() "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"noexcept"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" { "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"return"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" {}; }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"void"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-941699"},"children":[{"type":"text","value":"return_void"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"() {}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"void"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-941699"},"children":[{"type":"text","value":"unhandled_exception"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"() {}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-941699"},"children":[{"type":"text","value":"std"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"::"}]},{"type":"element","tag":"span","props":{"class":"ct-941699"},"children":[{"type":"text","value":"suspend_always"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-941699"},"children":[{"type":"text","value":"yield_value"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"int"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-880416"},"children":[{"type":"text","value":"value"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":") {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"            current_value "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" value;\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"            "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"return"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" {};\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"        }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"    };\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-941699"},"children":[{"type":"text","value":"std"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"::coroutine_handle"}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"promise_type"}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":">"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" coroutine;\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-941699"},"children":[{"type":"text","value":"CountingCoroutine"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-941699"},"children":[{"type":"text","value":"std"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"::"}]},{"type":"element","tag":"span","props":{"class":"ct-941699"},"children":[{"type":"text","value":"coroutine_handle"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"class":"ct-941699"},"children":[{"type":"text","value":"promise_type"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"> "}]},{"type":"element","tag":"span","props":{"class":"ct-880416"},"children":[{"type":"text","value":"handle"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":") : "}]},{"type":"element","tag":"span","props":{"class":"ct-941699"},"children":[{"type":"text","value":"coroutine"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"(handle) {}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":25},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":26},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-941699"},"children":[{"type":"text","value":"~CountingCoroutine"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"() {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":27},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"if"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" (coroutine)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":28},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"            coroutine."}]},{"type":"element","tag":"span","props":{"class":"ct-941699"},"children":[{"type":"text","value":"destroy"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"();\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":29},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"    }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":30},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":31},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"int"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-941699"},"children":[{"type":"text","value":"getValue"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"() "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"const"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":32},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"return"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" coroutine."}]},{"type":"element","tag":"span","props":{"class":"ct-941699"},"children":[{"type":"text","value":"promise"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"().current_value;\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":33},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"    }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":34},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":35},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"void"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-941699"},"children":[{"type":"text","value":"resume"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"() {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":36},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"        coroutine."}]},{"type":"element","tag":"span","props":{"class":"ct-941699"},"children":[{"type":"text","value":"resume"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"();\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":37},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"    }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":38},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"};\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":39},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":40},"children":[{"type":"element","tag":"span","props":{"class":"ct-941699"},"children":[{"type":"text","value":"CountingCoroutine"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-941699"},"children":[{"type":"text","value":"generateNumbers"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"() {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":41},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"for"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"int"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" i "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-055721"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"; i "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-055721"},"children":[{"type":"text","value":"10"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"; "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"++"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"i) {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":42},"children":[{"type":"element","tag":"span","props":{"class":"ct-782603"},"children":[{"type":"text","value":"        //移交控制权\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":43},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"co_yield"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" i;\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":44},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"    }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":45},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":46},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":47},"children":[{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"int"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-941699"},"children":[{"type":"text","value":"main"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"() {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":48},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"    CountingCoroutine counter "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-941699"},"children":[{"type":"text","value":"generateNumbers"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"();\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":49},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":50},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"while"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" (counter.coroutine) {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":51},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-941699"},"children":[{"type":"text","value":"std"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"::cout "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"<<"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-695486"},"children":[{"type":"text","value":"\"Value: \""}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"<<"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" counter."}]},{"type":"element","tag":"span","props":{"class":"ct-941699"},"children":[{"type":"text","value":"getValue"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"() "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"<<"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-941699"},"children":[{"type":"text","value":"std"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"::endl;\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":52},"children":[{"type":"element","tag":"span","props":{"class":"ct-782603"},"children":[{"type":"text","value":"        //回到 co_yield 继续执行\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":53},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"        counter."}]},{"type":"element","tag":"span","props":{"class":"ct-941699"},"children":[{"type":"text","value":"resume"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"();\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":54},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"    }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":55},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":56},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"return"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-055721"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":";\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":57},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"}"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"在 Go 语言中, 我们可以通过 chan 在没有特定从属关系的情况下完成协程间控制权的转移, 也算是对称协程的实现:"}]},{"type":"element","tag":"code","props":{"className":["language-go"],"code":"func main() {\n    ch1 := make(chan int)\n    ch2 := make(chan int)\n\n    var wg sync.WaitGroup\n\n    wg.Add(1)\n    go func() { // <--- 1\n        defer wg.Done()\n        for val := range ch1 {\n            fmt.Println(val)\n        }\n    }()\n\n    wg.Add(1)\n    go func() { // <--- 2\n        defer wg.Done()\n        for val := range ch2 {\n            ch1 <- val\n        }\n        close(ch1)\n    }()\n\n    wg.Add(1)\n    go func() { // <--- 3\n        defer wg.Done()\n        for i := 1; i <= 5; i++ {\n            ch2 <- i\n        }\n        close(ch2)\n    }()\n\n    wg.Wait()\n}\n","language":"go","meta":""},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"func"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-941699"},"children":[{"type":"text","value":"main"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"() {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"    ch1 "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":":="}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-055721"},"children":[{"type":"text","value":"make"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"chan"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"int"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"    ch2 "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":":="}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-055721"},"children":[{"type":"text","value":"make"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"chan"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"int"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"var"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" wg sync.WaitGroup\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"    wg."}]},{"type":"element","tag":"span","props":{"class":"ct-055721"},"children":[{"type":"text","value":"Add"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-055721"},"children":[{"type":"text","value":"1"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"go"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"func"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"() { "}]},{"type":"element","tag":"span","props":{"class":"ct-782603"},"children":[{"type":"text","value":"// <--- 1\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"defer"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" wg."}]},{"type":"element","tag":"span","props":{"class":"ct-055721"},"children":[{"type":"text","value":"Done"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"for"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" val "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":":="}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"range"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" ch1 {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"            fmt."}]},{"type":"element","tag":"span","props":{"class":"ct-055721"},"children":[{"type":"text","value":"Println"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"(val)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"        }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"    }()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"    wg."}]},{"type":"element","tag":"span","props":{"class":"ct-055721"},"children":[{"type":"text","value":"Add"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-055721"},"children":[{"type":"text","value":"1"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"go"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"func"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"() { "}]},{"type":"element","tag":"span","props":{"class":"ct-782603"},"children":[{"type":"text","value":"// <--- 2\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"defer"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" wg."}]},{"type":"element","tag":"span","props":{"class":"ct-055721"},"children":[{"type":"text","value":"Done"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"for"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" val "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":":="}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"range"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" ch2 {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"            ch1 "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"<-"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" val\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"        }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-055721"},"children":[{"type":"text","value":"close"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"(ch1)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"    }()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"    wg."}]},{"type":"element","tag":"span","props":{"class":"ct-055721"},"children":[{"type":"text","value":"Add"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-055721"},"children":[{"type":"text","value":"1"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":25},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"go"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"func"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"() { "}]},{"type":"element","tag":"span","props":{"class":"ct-782603"},"children":[{"type":"text","value":"// <--- 3\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":26},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"defer"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" wg."}]},{"type":"element","tag":"span","props":{"class":"ct-055721"},"children":[{"type":"text","value":"Done"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":27},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"for"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" i "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":":="}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-055721"},"children":[{"type":"text","value":"1"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"; i "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"<="}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-055721"},"children":[{"type":"text","value":"5"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"; i"}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"++"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":28},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"            ch2 "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"<-"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" i\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":29},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"        }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":30},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"        "}]},{"type":"element","tag":"span","props":{"class":"ct-055721"},"children":[{"type":"text","value":"close"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"(ch2)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":31},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"    }()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":32},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":33},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"    wg."}]},{"type":"element","tag":"span","props":{"class":"ct-055721"},"children":[{"type":"text","value":"Wait"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":34},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"}"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"如果按照代码的顺序执行, 那正确的排列顺序是 3 2 1, 但在此处由于channel的阻塞特性, 第一个goroutine会等待第二个goroutine将数据从 ch2 传输到 ch1, 而第二个goroutine会等待第三个goroutine将数据发送到 ch2, 这就保证了它们的执行顺序. 最后，当所有goroutine都完成并且WaitGroup计数为0时, wg.Wait() 返回, 程序退出."}]},{"type":"element","tag":"h3","props":{"id":"非对称"},"children":[{"type":"text","value":"非对称"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"JavaScript 的 async、await、promise 则是创建非对称协程的工具."}]},{"type":"element","tag":"code","props":{"className":["language-javascript"],"code":"// async 标记的函数会创建协程\nconst useFetch = async () => { \n  // 执行到 await 处会将该协程挂起, 直到 fetch 返回\n  const res = await fetch('https://www.v2ex.com/api/topics/hot.json')\n  return res.json()\n}\n\nconst main = () => {\n  console.log('main start')\n  // 执行到此处, 控制权转移到协程\n  useFetch().then(res => { \n    // 执行到函数内部 await 处, 暂时挂起, 控制权返回到 main\n    console.log(`fetch res: ${res}`)\n  })\n  console.log('main end')\n}\n\nmain()\n/**\n * main start\n * main end\n * fetch res: ...\n */\n","language":"javascript","meta":""},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"class":"ct-782603"},"children":[{"type":"text","value":"// async 标记的函数会创建协程\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"const"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-941699"},"children":[{"type":"text","value":"useFetch"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"async"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" () "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"=>"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" { \n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"  "}]},{"type":"element","tag":"span","props":{"class":"ct-782603"},"children":[{"type":"text","value":"// 执行到 await 处会将该协程挂起, 直到 fetch 返回\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"  "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"const"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-055721"},"children":[{"type":"text","value":"res"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"await"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-941699"},"children":[{"type":"text","value":"fetch"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-695486"},"children":[{"type":"text","value":"'https://www.v2ex.com/api/topics/hot.json'"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"  "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"return"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" res."}]},{"type":"element","tag":"span","props":{"class":"ct-941699"},"children":[{"type":"text","value":"json"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"const"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-941699"},"children":[{"type":"text","value":"main"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" () "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"=>"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"  console."}]},{"type":"element","tag":"span","props":{"class":"ct-941699"},"children":[{"type":"text","value":"log"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-695486"},"children":[{"type":"text","value":"'main start'"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"  "}]},{"type":"element","tag":"span","props":{"class":"ct-782603"},"children":[{"type":"text","value":"// 执行到此处, 控制权转移到协程\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"  "}]},{"type":"element","tag":"span","props":{"class":"ct-941699"},"children":[{"type":"text","value":"useFetch"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"()."}]},{"type":"element","tag":"span","props":{"class":"ct-941699"},"children":[{"type":"text","value":"then"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-880416"},"children":[{"type":"text","value":"res"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-984823"},"children":[{"type":"text","value":"=>"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":" { \n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-782603"},"children":[{"type":"text","value":"// 执行到函数内部 await 处, 暂时挂起, 控制权返回到 main\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"    console."}]},{"type":"element","tag":"span","props":{"class":"ct-941699"},"children":[{"type":"text","value":"log"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-695486"},"children":[{"type":"text","value":"`fetch res: ${"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"res"}]},{"type":"element","tag":"span","props":{"class":"ct-695486"},"children":[{"type":"text","value":"}`"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"  })\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"  console."}]},{"type":"element","tag":"span","props":{"class":"ct-941699"},"children":[{"type":"text","value":"log"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"class":"ct-695486"},"children":[{"type":"text","value":"'main end'"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"class":"ct-941699"},"children":[{"type":"text","value":"main"}]},{"type":"element","tag":"span","props":{"class":"ct-212337"},"children":[{"type":"text","value":"()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"class":"ct-782603"},"children":[{"type":"text","value":"/**\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"class":"ct-782603"},"children":[{"type":"text","value":" * main start\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"class":"ct-782603"},"children":[{"type":"text","value":" * main end\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"class":"ct-782603"},"children":[{"type":"text","value":" * fetch res: ...\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"class":"ct-782603"},"children":[{"type":"text","value":" */"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"可以看到, 在 JS 中, 协程转移的控制权一定会返回到协程的调用者上."}]},{"type":"element","tag":"h1","props":{"id":"异同"},"children":[{"type":"text","value":"异同"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"看到这里, 会发现纤程和协程极为相似.\n没错, 大框架上两者的基本概念是一样的. 仅有的区别是纤程的状态保存由操作系统API提供, 而协程保存和恢复的方式由语言或库提供, 背后的实现更是则多种多样.\n所以我们可以认为: 纤程实际上就是由操作系统提供的协程.\n参考"},{"type":"element","tag":"a","props":{"href":"https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2014/n4024.pdf","rel":["nofollow"]},"children":[{"type":"text","value":"Distinguishing coroutines and fibers"}]},{"type":"text","value":", 以下是一些细节的差别:"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Fiber 在发起后不再依赖于发起它的程序存在, 可以拥有独立的生命周期.\nCoroutine 作为发起者的「子程序」, 不存在独立的生命周期."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Fiber 和 Thread 行为模式基本一致. 存在一个调度器, 某个 Fiber 被阻塞, 会将控制权移交至调度器, 由调度器去唤起其他准备运行的 Fiber.\n对称协程的行为方式和 Fiber 基本一致. 非对称协程不存在调度器, 控制权会回到发起者."}]}]},{"type":"element","tag":"style","children":[{"type":"text","value":".ct-984823{color:#F97583;}\n.light .ct-984823{color:#D73A49;}\n.ct-212337{color:#E1E4E8;}\n.light .ct-212337{color:#24292E;}\n.ct-695486{color:#9ECBFF;}\n.light .ct-695486{color:#032F62;}\n.ct-941699{color:#B392F0;}\n.light .ct-941699{color:#6F42C1;}\n.ct-055721{color:#79B8FF;}\n.light .ct-055721{color:#005CC5;}\n.ct-880416{color:#FFAB70;}\n.light .ct-880416{color:#E36209;}\n.ct-782603{color:#6A737D;}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"有栈协程和无栈协程","depth":2,"text":"有栈协程和无栈协程"},{"id":"对称协程和非对称协程","depth":2,"text":"对称协程和非对称协程","children":[{"id":"对称","depth":3,"text":"对称"},{"id":"非对称","depth":3,"text":"非对称"}]}]}},"_type":"markdown","_id":"content:1692667782462.md","_source":"content","_file":"1692667782462.md","_extension":"md"}],"navigation":[{"title":"协程(Coroutine)和纤程(Fiber)","_path":"/1692667782462"}]}